<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biometric Scanner v3</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
    <style>
        :root { --glow: #00f2ff; --error: #ff4444; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; font-family: monospace; overflow: hidden; }
        
        #video { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        
        /* The UI Mask */
        .overlay { position: absolute; inset: 0; z-index: 5; pointer-events: none; }
        .mask {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            mask: radial-gradient(ellipse 35% 45% at 50% 50%, transparent 99%, black 100%);
            -webkit-mask: radial-gradient(ellipse 35% 45% at 50% 50%, transparent 99%, black 100%);
        }
        .oval {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50vh; height: 70vh; border: 2px solid var(--glow); border-radius: 50%;
            box-shadow: 0 0 15px var(--glow);
        }

        /* Level Bar */
        .level-meter { position: absolute; top: 78%; left: 50%; width: 200px; height: 2px; background: #333; transform: translateX(-50%); }
        #pointer { width: 40px; height: 4px; background: var(--glow); position: absolute; left: 50%; margin-left: -20px; transition: 0.1s; }

        /* HUD & Debug */
        .hud { position: absolute; width: 100%; text-align: center; z-index: 10; }
        .top { top: 20px; }
        .bottom { bottom: 30px; pointer-events: auto; }
        
        #debug-log { font-size: 10px; color: #aaa; background: rgba(0,0,0,0.5); padding: 5px; position: absolute; top: 0; left: 0; pointer-events: none; }
        .status { background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid var(--glow); display: inline-block; margin-bottom: 10px; }

        .btn { background: #222; border: 1px solid white; color: white; padding: 12px 20px; cursor: pointer; text-transform: uppercase; margin: 5px; }
        .capture-btn { background: var(--glow); color: black; border: none; font-weight: bold; opacity: 0.2; pointer-events: none; }
        .capture-btn.ready { opacity: 1; pointer-events: auto; box-shadow: 0 0 15px var(--glow); }
    </style>
</head>
<body>

    <div id="debug-log">System Booting...</div>
    <video id="video" autoplay playsinline muted></video>

    <div class="overlay">
        <div class="mask"></div>
        <div class="oval"></div>
        <div class="level-meter"><div id="pointer"></div></div>
    </div>

    <div class="hud top">
        <h2 style="letter-spacing: 5px; margin: 0;">AI SCANNER</h2>
    </div>

    <div class="hud bottom">
        <div class="status" id="status">SENSOR LOCK REQUIRED</div><br>
        <button class="btn" id="initBtn" onclick="startup()">Initialize</button>
        <button class="btn" onclick="flip()">Flip</button>
        <button class="btn capture-btn" id="capBtn" onclick="save()">Capture</button>
    </div>

    <canvas id="canvas" style="display:none"></canvas>

    <script>
        const log = (msg) => { document.getElementById('debug-log').innerText += `\n> ${msg}`; console.log(msg); };
        const status = document.getElementById('status');
        const video = document.getElementById('video');
        let useFront = true;
        let faceOK = false, levelOK = false;

        async function startup() {
            document.getElementById('initBtn').style.display = 'none';
            log("Init started...");

            // 1. Level Sensors (iOS 13+ fix)
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const res = await DeviceOrientationEvent.requestPermission();
                if (res === 'granted') window.addEventListener('deviceorientation', doLevel);
            } else {
                window.addEventListener('deviceorientation', doLevel);
            }

            // 2. Load Models
            try {
                log("Loading AI Models...");
                const URL = "https://raw.githubusercontent.com/vladmandic/face-api/master/model/";
                await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
                log("Models Loaded.");
                await startCam();
            } catch (e) {
                log("ERR: Model CORS/Network issue.");
                status.innerText = "CONNECTION ERROR";
            }
        }

        async function startCam() {
            log("Accessing Camera...");
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: useFront ? "user" : "environment" }
                });
                video.srcObject = stream;
                video.style.transform = useFront ? "scaleX(-1)" : "scaleX(1)";
                video.onloadedmetadata = () => {
                    log("Stream active.");
                    detect();
                };
            } catch (e) {
                log(`ERR: ${e.name}`);
                status.innerText = "CAMERA BLOCKED";
            }
        }

        function doLevel(e) {
            let tilt = e.gamma;
            if (tilt === null) return;
            document.getElementById('pointer').style.transform = `rotate(${tilt}deg)`;
            levelOK = Math.abs(tilt) < 5;
            document.getElementById('pointer').style.background = levelOK ? "#00ff00" : "var(--glow)";
            sync();
        }

        async function detect() {
            const opt = new faceapi.TinyFaceDetectorOptions();
            setInterval(async () => {
                const result = await faceapi.detectSingleFace(video, opt);
                faceOK = !!result;
                sync();
            }, 300);
        }

        function sync() {
            if (!faceOK) { status.innerText = "FRAME FACE"; status.style.color = "white"; }
            else if (!levelOK) { status.innerText = "LEVEL DEVICE"; status.style.color = "orange"; }
            else { status.innerText = "LOCKED: READY"; status.style.color = "#00ff00"; }

            const btn = document.getElementById('capBtn');
            if (faceOK && levelOK) btn.classList.add('ready');
            else btn.classList.remove('ready');
        }

        function flip() { useFront = !useFront; startCam(); }

        function save() {
            const cvs = document.getElementById('canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = video.videoWidth; cvs.height = video.videoHeight;
            if (useFront) { ctx.translate(cvs.width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0);
            
            const link = document.createElement('a');
            link.download = 'Scan.png';
            link.href = cvs.toDataURL();
            link.click();
            log("Saved.");
        }
    </script>
</body>
</html>
