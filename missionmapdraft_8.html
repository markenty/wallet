<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Maps ‚Äî Fullscreen + Overlay Missions</title>
<style>
  :root { --bg:#0f1115; --panel:#151923; --muted:#9aa4b2; --text:#e8edf5; --accent:#67d5b5; --accent2:#7aa2ff; --danger:#ff6b6b; }
  *{ box-sizing:border-box; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial; }

  /* Fullscreen My Maps as bottom layer */
  #mapFrame {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
    background: #0b0e14;
  }

  /* Overlay root (pointer-events defaults to auto) */
  #overlay {
    position: fixed;
    inset: 0;
    display: grid;
    grid-template-rows: auto auto 1fr;
    pointer-events: none; /* allow clicks through where we don't need them */
  }

  /* Top control bar */
  #toolbar {
    pointer-events: auto;
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    background: rgba(12,15,20,.92);
    border-bottom: 1px solid #1c2333;
    backdrop-filter: blur(6px);
  }
  .title { font-weight:700; letter-spacing:.2px; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  input, button { font:inherit; }
  input[type="search"], input[type="url"] {
    background:#10141d; color:var(--text); border:1px solid #232c44; border-radius:10px; padding:10px;
  }
  .btn { background:#1a2131; color:var(--text); border:1px solid #24304a; padding:10px 12px; border-radius:10px; cursor:pointer; transition:.15s; }
  .btn:hover { transform:translateY(-1px); border-color:#324166; }
  .btn.accent { background:linear-gradient(180deg,#2a3f36,#1e2f29); border-color:#2f574a; color:#d6fff3; }
  .btn.danger { background:#2a1e23; border-color:#5e2e39; color:#ffd7dd; }
  .tiny { font-size:12px; color:var(--muted); }

  /* Source bar */
  #sourceBar {
    pointer-events: auto;
    display:flex; align-items:center; gap:8px;
    padding:6px 12px;
    background: rgba(21,25,35,.92);
    border-bottom:1px solid #1c2333;
  }
  #sheetUrl, #mapUrl { width: 36ch; max-width: 45vw; }
  .uploadCtl input { display: none; }
  .uploadCtl label { cursor:pointer; }

  /* Mission stack (cards) */
  #missions {
    pointer-events: auto; /* overlay is interactive */
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 380px));
    gap: 12px;
    align-content: start;
    overflow: auto;
    height: 100%;
    background: rgba(255,255,255,0.06);
  }

  .card {
    background: #111722;
    border: 1px solid #223052;
    border-radius: 12px;
    box-shadow: 0 10px 28px rgba(0,0,0,.25);
    overflow: hidden;
  }
  .cardHeader {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding: 10px 12px;
    background: #0f1520;
    border-bottom:1px solid #1c2333;
  }
  .cardTitle { font-weight:700; }
  .pill {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    background: #19263c;
    color:#cfe0ff;
    border:1px solid #243a5e;
    margin-right:6px;
  }
  .coord { color: var(--muted); font-size:12px; }
  .desc { color:#cfd5e2; margin:10px 0 12px; }
  .cardBody { padding: 10px 12px 12px; }

  .progress {
    background:#0e1320; border:1px solid #1c2741; border-radius: 999px; height: 12px;
    overflow: hidden; position: relative; margin-bottom: 10px;
  }
  .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #1dd1a1, #10ac84); transition: width 300ms ease; }
  .pctText { font-size:12px; color:#c9d4ea; position: absolute; right: 6px; top: -22px; }

  .tags { display:flex; flex-wrap:wrap; gap:6px; }
  .tag { font-size:11px; padding:3px 6px; border-radius:6px; background:#0e1320; color:#cbd4e9; border:1px solid #1c2741; }

  .metaRow { display:flex; flex-wrap:wrap; align-items:center; gap:8px; color:var(--muted); font-size:12px; margin-top:4px; }
  .sep { color:#4c5877; }

  .actions { display:flex; gap:8px; margin-top:10px; }
  .actions .btn { padding:6px 10px; }

  /* Hidden/Collapsed states */
  .card.hidden { display:none; }
  .card.collapsed .cardBody { display:none; }

  /* Overlay visibility */
  .overlay-hidden #toolbar, .overlay-hidden #sourceBar, .overlay-hidden #missions { display:none; }
  .overlay-hidden #overlay { pointer-events:none; }

  /* Opacity (affects mission grid background only) */
  #missions[data-alpha] { background: rgba(255,255,255, var(--alpha, .06)); }

  /* Overlay Tab (always visible) */
  #overlayTab {
    position: fixed;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 30;
    background: #111a2a;
    color: #eaf1ff;
    border: 1px solid #2a3a5a;
    border-radius: 10px 10px 10px 10px;
    padding: 8px 10px;
    box-shadow: 0 10px 24px rgba(0,0,0,.35);
    display: none; /* default hidden */
    cursor: pointer;
    user-select: none;
  }
  #overlayTab span { display: inline-block; font-weight: 700; font-size: 12px; letter-spacing: .25px; }
  /* Show the tab when overlay is hidden */
  .overlay-hidden #overlayTab { display: block; }

  /* Modal */
  dialog { border:1px solid #24304a; background:#0f1520; color:var(--text); border-radius:12px; padding:0; width:min(520px, 96vw); }
  .modalHead { padding:12px; border-bottom:1px solid #1c2333; font-weight:700; background:#101827; }
  .modalBody { padding:12px; }
  .modalFoot { padding:12px; border-top:1px solid #1c2333; display:flex; gap:8px; justify-content:flex-end; }
  .field { display:grid; grid-template-columns: 120px 1fr; align-items:center; gap:10px; margin-bottom:10px; }
  .field input, .field textarea { width:100%; background:#10141d; color:var(--text); border:1px solid #232c44; border-radius:10px; padding:8px; }
  .field textarea { min-height:80px; }
  .kbd { padding:2px 6px; border:1px solid #324166; background:#0e1320; border-radius:6px; font-size:12px; }
</style>
</head>
<body>
  <!-- Bottom-layer map -->
  <iframe id="mapFrame" allowfullscreen></iframe>

  <!-- Always-visible tab to reopen overlay when hidden -->
  <div id="overlayTab" title="Show overlay"><span>Show Overlay</span></div>

  <!-- Overlay UI -->
  <div id="overlay">
    <div id="toolbar">
      <div class="title">üó∫Ô∏è My Maps <span class="tiny">Fullscreen overlay</span></div>
      <div class="controls">
        <input type="search" id="search" placeholder="Search missions‚Ä¶">
        <label class="tiny">Opacity <input type="range" id="opacity" min="0.05" max="0.95" step="0.05" value="0.35"></label>
        <button class="btn" id="btnToggle">Hide Overlay</button>
        <button class="btn" id="btnShare">Share Link</button>
        <button class="btn" id="btnTemplate">CSV Template</button>
        <button class="btn" id="btnExportJSON">Export JSON</button>
        <button class="btn danger" id="btnClear">Clear</button>
      </div>
    </div>

    <div id="sourceBar">
      <div class="controls">
        <input type="url" id="mapUrl" placeholder="My Maps URL (edit or embed)" />
        <button class="btn accent" id="btnSetMap">Set Map</button>
        <input type="url" id="sheetUrl" placeholder="Sheet URL or CSV (auto-detect)" />
        <button class="btn" id="btnFetch">Fetch</button>
        <span class="uploadCtl">
          <input type="file" id="fileInput" accept=".csv">
          <label class="btn" id="uploadLabel">Upload CSV</label>
        </span>
        <button class="btn" id="btnAdd">+ Mission</button>
        <span class="tiny">Headers: Title,Description,Latitude,Longitude,Status,Start,End,Progress,Tags</span>
      </div>
    </div>

    <div id="missions" data-alpha></div>
  </div>

  <!-- Add/Edit Mission Modal -->
  <dialog id="missionDlg">
    <div class="modalHead">Add Mission</div>
    <div class="modalBody">
      <div class="field"><label>Title</label><input id="fTitle" required></div>
      <div class="field"><label>Description</label><textarea id="fDesc"></textarea></div>
      <div class="field"><label>Latitude</label><input id="fLat" type="number" step="any"></div>
      <div class="field"><label>Longitude</label><input id="fLng" type="number" step="any"></div>
      <div class="field"><label>Status</label><input id="fStatus" placeholder="Planned/Active/Done"></div>
      <div class="field"><label>Start</label><input id="fStart" type="datetime-local"></div>
      <div class="field"><label>End</label><input id="fEnd" type="datetime-local"></div>
      <div class="field"><label>Progress</label><input id="fProg" type="number" min="0" max="100" step="1" value="0"></div>
      <div class="field"><label>Tags</label><input id="fTags" placeholder="comma or semicolon separated"></div>
    </div>
    <div class="modalFoot">
      <button class="btn" id="btnCancel">Cancel</button>
      <button class="btn accent" id="btnSave">Save</button>
    </div>
  </dialog>

<script>
// ---------- Query params ----------
const qs = new URLSearchParams(location.search);
const mapParam = qs.get('map') || '';
const sheetParam = qs.get('sheet') || '';

// ---------- Elements ----------
const mapFrame = document.getElementById('mapFrame');
const missions = document.getElementById('missions');
const searchBox = document.getElementById('search');
const opacity = document.getElementById('opacity');
const overlayTab = document.getElementById('overlayTab');
const uploadLabel = document.getElementById('uploadLabel');

// ---------- State ----------
let data = []; // normalized missions
const KEY_DATA = 'mymaps_overlay_missions_v1';
const KEY_MAP = 'mymaps_overlay_map_v1';

// ---------- Helpers ----------
function toEmbedMyMaps(url){
  try{
    const u = new URL(url);
    if(!/google\.[^/]+\/maps\/d\//.test(u.href)) return url; // not a My Maps URL
    const mid = u.searchParams.get('mid') || u.pathname.split('/').find(s=>s.length>10 && !isNaN(Number.NaN));
    if(!mid) return url;
    return `https://www.google.com/maps/d/embed?mid=${encodeURIComponent(mid)}&ehbc=2E312F`;
  }catch{ return url; }
}

function toCsvExport(url){
  // Accepts: normal Google Sheet URL and returns CSV export URL; otherwise return input
  try{
    const u = new URL(url);
    const isSheet = /docs\.google\.com\/spreadsheets\//.test(u.href);
    if(!isSheet) return url; // maybe already CSV
    const gid = u.searchParams.get('gid') || '0';
    const base = u.origin + u.pathname.replace(/\/edit.*$/, '');
    return `${base}/export?format=csv&gid=${gid}`;
  }catch{ return url; }
}

function copy(text){
  navigator.clipboard?.writeText(text).then(()=>{
    toast('Copied to clipboard');
  }).catch(()=>{});
}

function toast(msg){
  const d=document.createElement('div');
  d.textContent=msg; d.style.position='fixed'; d.style.bottom='14px'; d.style.left='50%'; d.style.transform='translateX(-50%)';
  d.style.background='#101827'; d.style.border='1px solid #24304a'; d.style.padding='8px 12px'; d.style.borderRadius='10px'; d.style.boxShadow='0 10px 24px rgba(0,0,0,.35)';
  document.body.appendChild(d); setTimeout(()=>d.remove(), 1600);
}

// ---------- CSV parse (quoted fields supported) ----------
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"'){
        if(text[i+1]==='"'){ field+='"'; i++; } else { inQ=false; }
      } else field+=c;
    } else {
      if(c==='"'){ inQ=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
      else if(c==='\r'){ /* ignore */ }
      else field+=c;
    }
    i++;
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}

// ---------- Normalize ----------
function normalize(obj){
  return {
    title: obj.Title || obj.Name || 'Untitled',
    desc: obj.Description || obj.Notes || '',
    lat: Number(obj.Latitude),
    lng: Number(obj.Longitude),
    status: obj.Status || 'Planned',
    start: obj.Start || '',
    end: obj.End || '',
    progress: Math.max(0, Math.min(100, Number(obj.Progress||0))),
    tags: (obj.Tags||'').split(/[,;]\s*/).filter(Boolean)
  };
}

// ---------- Render ----------
function buildCard(it){
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <div class="cardHeader">
      <div>
        <span class="pill">${escapeHTML(it.status)}</span>
        <span class="cardTitle">${escapeHTML(it.title)}</span>
        <div class="metaRow">
          <span class="coord">${isFinite(it.lat)&&isFinite(it.lng) ? it.lat.toFixed(5)+', '+it.lng.toFixed(5) : '‚Äî'}</span>
          <span class="sep">‚Ä¢</span>
          <a class="tiny" target="_blank" rel="noopener" href="${mapsLink(it)}">Open in Maps</a>
          <span class="sep">‚Ä¢</span>
          <span class="timer"></span>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-sm collapseBtn" aria-expanded="true" title="Collapse [C]"><span>Collapse</span></button>
        <button class="btn btn-sm danger hideBtn" title="Hide [H]">Hide</button>
      </div>
    </div>
    <div class="cardBody">
      <div class="desc">${it.desc ? escapeHTML(it.desc).replace(/\n/g,'<br>') : '‚Äî'}</div>
      <div class="progress"><div class="bar"></div><span class="pctText"></span></div>
      <div class="tags"></div>
    </div>
  `;

  const bar = el.querySelector('.bar');
  const pctText = el.querySelector('.pctText');
  const timerEl = el.querySelector('.timer');
  const collapseBtn = el.querySelector('.collapseBtn');

  // progress
  bar.style.width = it.progress + '%';
  pctText.textContent = it.progress + '%';

  // tags
  const tagsWrap = el.querySelector('.tags');
  it.tags.forEach(t=>{
    const span = document.createElement('span');
    span.className = 'tag';
    span.textContent = t;
    tagsWrap.appendChild(span);
  });

  // collapse
  collapseBtn.addEventListener('click', () => {
    const isColl = el.classList.toggle('collapsed');
    collapseBtn.firstChild.textContent = isColl ? 'Expand' : 'Collapse';
    collapseBtn.setAttribute('aria-expanded', String(!isColl));
  });

  // hide
  el.querySelector('.hideBtn').addEventListener('click', () => el.classList.add('hidden'));

  // live timer to End
  if (it.end) {
    const endTs = new Date(it.end).getTime();
    const startTs = it.start ? new Date(it.start).getTime() : null;
    const tick = () => {
      const now = Date.now();
      const remain = endTs - now;
      if (!isFinite(remain)) { timerEl.textContent = ''; return; }
      if (remain <= 0) { timerEl.textContent = 'Done'; bar.style.width = '100%'; pctText.textContent = '100%'; return; }
      timerEl.textContent = fmtDuration(remain) + ' left';
      if (startTs && endTs>startTs) {
        const pct = Math.round(100 * (now - startTs) / (endTs - startTs));
        const clamp = Math.max(0, Math.min(100, pct));
        bar.style.width = clamp + '%'; pctText.textContent = clamp + '%';
      }
    };
    tick(); setInterval(tick, 1000);
  }
  return el;
}

function render(){
  const q = (searchBox.value||'').toLowerCase();
  missions.innerHTML = '';
  data
    .filter(it => !q || (it.title+' '+it.desc+' '+it.tags.join(' ')).toLowerCase().includes(q))
    .forEach(it => missions.appendChild(buildCard(it)));
}

function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
function fmtDuration(ms){
  const sec = Math.floor(ms/1000);
  const d = Math.floor(sec/86400);
  const h = Math.floor((sec%86400)/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  const parts=[]; if(d)parts.push(d+'d'); if(h||d)parts.push(h+'h'); if(m||h||d)parts.push(m+'m'); parts.push(s+'s');
  return parts.join(' ');
}
function mapsLink(it){
  if(Number.isFinite(it.lat) && Number.isFinite(it.lng)) return `https://www.google.com/maps?q=${it.lat},${it.lng}`;
  return 'https://www.google.com/maps';
}

// ---------- Loading ----------
function fromCSV(text){
  const rows = parseCSV(text);
  if (!rows.length) return [];
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r => r.length && r.some(v => v && v.trim().length)).map(r => {
    const obj = {};
    headers.forEach((h,i)=>obj[h]= (r[i]??'').trim());
    return normalize(obj);
  });
}

// ---------- Controls ----------
// Overlay show/hide
 document.getElementById('btnToggle').addEventListener('click', () => {
  document.body.classList.toggle('overlay-hidden');
});

overlayTab.addEventListener('click', () => {
  document.body.classList.remove('overlay-hidden');
  overlayTab.style.opacity = '0.7';
  setTimeout(()=>overlayTab.style.opacity='1', 120);
});

opacity.addEventListener('input', () => {
  missions.style.setProperty('--alpha', opacity.value);
});

// Export JSON
 document.getElementById('btnExportJSON').addEventListener('click', () => {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)], {type:'application/json'}));
  a.download = 'missions.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),300);
});

// Clear
 document.getElementById('btnClear').addEventListener('click', () => {
  if(confirm('Clear stored missions?')){
    localStorage.removeItem(KEY_DATA);
    data = []; render();
  }
});

// Set Map (accept edit or embed URL)
 document.getElementById('btnSetMap').addEventListener('click', () => {
  const raw = document.getElementById('mapUrl').value.trim();
  if(!raw) return alert('Paste a My Maps URL.');
  const url = toEmbedMyMaps(raw);
  mapFrame.src = url; localStorage.setItem(KEY_MAP, url);
  if(url!==raw) toast('Converted to embed URL');
});

// Fetch Sheet/CSV (auto-detect)
 document.getElementById('btnFetch').addEventListener('click', async () => {
  const raw = document.getElementById('sheetUrl').value.trim();
  if(!raw) return alert('Paste a Google Sheet URL or a CSV URL.');
  const url = /google\.com/.test(raw) ? toCsvExport(raw) : raw;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(res.status+': '+res.statusText);
    const text = await res.text();
    data = fromCSV(text); localStorage.setItem(KEY_DATA, JSON.stringify(data)); render();
    alert('Loaded '+data.length+' missions.');
  }catch(e){
    alert('Fetch failed (permissions or CORS). Try File ‚Üí Share ‚Üí Anyone with the link (Viewer), or use Upload CSV.');
  }
});

// Upload CSV
 document.querySelector('.uploadCtl label').addEventListener('click', () => document.getElementById('fileInput').click());
 document.getElementById('fileInput').addEventListener('change', async e => {
  const f = e.target.files[0]; if(!f) return;
  uploadLabel.textContent = 'Uploaded: '+f.name;
  const text = await f.text();
  data = fromCSV(text); localStorage.setItem(KEY_DATA, JSON.stringify(data)); render();
});

// Search
 searchBox.addEventListener('input', render);

// Share Link builder
 document.getElementById('btnShare').addEventListener('click', () => {
  const map = document.getElementById('mapUrl').value.trim() || localStorage.getItem(KEY_MAP) || '';
  const sheet = document.getElementById('sheetUrl').value.trim() || '';
  const params = new URLSearchParams();
  if(map) params.set('map', map);
  if(sheet) params.set('sheet', sheet);
  const url = location.origin + location.pathname + '?' + params.toString();
  copy(url);
});

// CSV Template download
 document.getElementById('btnTemplate').addEventListener('click', () => {
  const csv = 'Title,Description,Latitude,Longitude,Status,Start,End,Progress,Tags\n';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = 'missions_template.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),300);
});

// Add Mission modal
const dlg = document.getElementById('missionDlg');
const btnAdd = document.getElementById('btnAdd');
const btnCancel = document.getElementById('btnCancel');
const btnSave = document.getElementById('btnSave');
btnAdd.addEventListener('click', ()=>{ dlg.showModal(); });
btnCancel.addEventListener('click', ()=> dlg.close());
btnSave.addEventListener('click', ()=>{
  const it = normalize({
    Title: document.getElementById('fTitle').value,
    Description: document.getElementById('fDesc').value,
    Latitude: document.getElementById('fLat').value,
    Longitude: document.getElementById('fLng').value,
    Status: document.getElementById('fStatus').value,
    Start: document.getElementById('fStart').value,
    End: document.getElementById('fEnd').value,
    Progress: document.getElementById('fProg').value,
    Tags: document.getElementById('fTags').value
  });
  if(!it.title.trim()) return alert('Title required');
  data.unshift(it); localStorage.setItem(KEY_DATA, JSON.stringify(data)); render(); dlg.close();
});

// Keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(e.key==='/' && document.activeElement!==searchBox){ e.preventDefault(); searchBox.focus(); }
  if(e.key==='n' && !e.metaKey && !e.ctrlKey){ btnAdd.click(); }
});

// ---------- Init ----------
(function init(){
  // Map
  const savedMap = localStorage.getItem(KEY_MAP);
  const map = mapParam || savedMap || '';
  if (map){ document.getElementById('mapUrl').value = map; mapFrame.src = toEmbedMyMaps(map); }

  // Data
  const saved = localStorage.getItem(KEY_DATA);
  if (sheetParam){
    const auto = /google\.com/.test(sheetParam) ? toCsvExport(sheetParam) : sheetParam;
    document.getElementById('sheetUrl').value = sheetParam;
    fetch(auto).then(r=>r.text()).then(t=>{ data = fromCSV(t); localStorage.setItem(KEY_DATA, JSON.stringify(data)); render(); }).catch(()=>{});
  } else if (saved){
    try{ data = JSON.parse(saved)||[]; }catch{ data = []; }
  } else {
    // Seed example
    const seed = `Title,Description,Latitude,Longitude,Status,Start,End,Progress,Tags\nWalmart Deli,Lacey WA,47.0604,-122.7731,Active,2025-08-31T12:00:00-07:00,2025-09-01T12:00:00-07:00,30,food;supply\nBriefing Point,Command staff meet here,47.0471,-122.8225,Planned,2025-08-31T10:00:00-07:00,2025-08-31T14:00:00-07:00,0,ops;briefing`;
    data = fromCSV(seed);
  }
  render();
})();
</script>
</body>
</html>
