<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Wallet System</title>
    <style>
        /* General Styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #ffffff;
        }

        /* Wallet Containers */
        #login-div, #wallet-div, .modal {
            border: 1px solid #333333;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            background-color: #1e1e1e;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.5);
        }

        /* Wallet Hidden by Default */
        #wallet-div {
            display: none;
        }

        /* Input Fields */
        input {
            width: 98.5%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #333333;
            border-radius: 5px;
            background-color: #292929;
            color: #ffffff;
        }

        input::placeholder {
            color: #888888;
        }

        /* Buttons */
        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #00d1b2;
            color: #121212;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #00bfa6;
            transform: scale(1.02);
        }

        button:active {
            background-color: #009f8a;
            transform: scale(1);
        }

        /* Transaction Log Styling */
        #transactions-log {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333333;
            border-radius: 5px;
            background-color: #1e1e1e;
            box-shadow: inset 0px 2px 10px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <h1>User Wallet System</h1>

    <div id="login-div">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email" required><br>
        <input type="password" id="password" placeholder="Password" required><br>
        <button id="login-btn">Login</button>
        <p>
            <a href="#" id="forgot-password-link">Forgot Password?</a> |
            <a href="#" id="register-link">Register</a>
        </p>
    </div>

    <div id="wallet-div">
        <h2>Wallet</h2>
        <p><strong>Email:</strong> <span id="user-email">N/A</span></p>
        <h1><p><strong>Balance:</strong> <span id="balance">0</span> coins</p></h1>
        <h3>Remaining Supply: <span id="remaining-supply">0</span> coins</h3>
        <p><strong>User ID:</strong> <span id="user-id">N/A</span></p>
        <h3>Send Coins</h3>
        <label for="recipient">Recipient:</label>
        <input type="text" id="recipient" placeholder="Recipient User ID"><br>
        <label for="amount">Amount:</label>
        <input type="number" id="amount" placeholder="Amount"><br>
        <button id="send-btn">Send</button>
        <h3>Transaction Log</h3>
        <div id="transactions-log"></div>
        <button id="logout-btn">Logout</button>
    </div>

    <script type="module">
     // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD2zSE_R3oQEOJST7BH0e5OAsDsPV0JzW8",
            authDomain: "wallet-18aba.firebaseapp.com",
            projectId: "wallet-18aba",
            storageBucket: "wallet-18aba.appspot.com",
            messagingSenderId: "926434300165",
            appId: "1:926434300165:web:0b5d3ba8f32de4d8cbe76c",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;

        // Initialize total supply tracking
        const totalSupplyDocRef = doc(db, "config", "totalSupply");

        async function loginUser() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;

                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    currentUser = { id: userId, email: userDoc.data().email, ...userDoc.data() };
                    initializeWalletUI();
                    updateRemainingSupply(); // Update remaining supply after login
                } else {
                    alert("User data not found.");
                }
            } catch (error) {
                console.error("Login failed:", error);
                alert("Failed to log in. Please check your credentials.");
            }
        }

        function initializeWalletUI() {
            document.getElementById("login-div").style.display = "none";
            document.getElementById("wallet-div").style.display = "block";

            document.getElementById("user-id").innerText = currentUser.id;
            document.getElementById("user-email").innerText = currentUser.email;
            document.getElementById("balance").innerText = currentUser.balance;
            loadTransactionLog();
        }

     async function sendCoins() {
    const recipientId = document.getElementById("recipient").value.trim();
    const amount = parseInt(document.getElementById("amount").value.trim(), 10);

    if (!recipientId || isNaN(amount) || amount <= 0) {
        alert("Please enter a valid recipient ID and amount.");
        return;
    }

    if (currentUser.balance < amount) {
        alert("Insufficient balance.");
        return;
    }

    try {
        // Fetch the recipient's document
        const recipientRef = doc(db, "users", recipientId);
        const recipientDoc = await getDoc(recipientRef);

        if (recipientDoc.exists()) {
            const newRecipientBalance = recipientDoc.data().balance + amount;
            await updateDoc(recipientRef, { balance: newRecipientBalance });

            // Update sender's balance
            const senderRef = doc(db, "users", currentUser.id);
            const newSenderBalance = currentUser.balance - amount;
            await updateDoc(senderRef, { balance: newSenderBalance });

            currentUser.balance = newSenderBalance;
            document.getElementById("balance").innerText = currentUser.balance;

            // Log the transaction
            await addDoc(collection(db, "transactions"), {
                sender: currentUser.id,
                receiver: recipientId,
                amount,
                timestamp: new Date().toISOString(),
            });

            alert(`Successfully sent ${amount} coins to ${recipientId}.`);
            loadTransactionLog();
            updateRemainingSupply();  // Update remaining supply after transaction
        } else {
            alert("Recipient not found.");
        }
    } catch (error) {
        console.error("Error sending coins:", error);
        alert("Failed to send coins. Check the console for details.");
    }
}

async function updateRemainingSupply() {
    try {
        // Fetch the total supply and current circulation from Firestore
        const totalSupplyDoc = await getDoc(totalSupplyDocRef);

        // Check if the document exists
        if (!totalSupplyDoc.exists()) {
            console.error("Firestore document 'config/totalSupply' does not exist.");
            return;
        }

        // Get the values of totalSupply and currentCirculation
        let totalSupply = totalSupplyDoc.data().totalSupply;
        let currentCirculation = 0;

        // Debugging: log the fetched values
        console.log("Fetched totalSupply:", totalSupply);  // Debug log for totalSupply
        console.log("Fetched currentCirculation:", totalSupplyDoc.data().currentCirculation);  // Debug log for currentCirculation

        // If totalSupply is undefined or NaN, log the error
        if (typeof totalSupply === 'undefined' || isNaN(totalSupply)) {
            console.error("Invalid totalSupply value:", totalSupply);
            return;  // Stop execution if totalSupply is invalid
        }

        // Fetch all user balances and calculate current circulation
        const usersSnapshot = await getDocs(collection(db, "users"));
        usersSnapshot.forEach((userDoc) => {
            currentCirculation += userDoc.data().balance || 0;
        });

        // Debugging log
        console.log("Calculated currentCirculation:", currentCirculation);  // Debug log for currentCirculation

        // Update currentCirculation in Firestore
        await updateDoc(totalSupplyDocRef, {
            currentCirculation: currentCirculation
        });

        // Ensure totalSupply and currentCirculation are valid numbers
        if (isNaN(totalSupply) || isNaN(currentCirculation)) {
            console.error("Invalid total supply or current circulation values.");
            return;
        }

        // Calculate remaining supply
        const remainingSupply = totalSupply - currentCirculation;

        // Debugging log for remainingSupply
        console.log("Remaining Supply:", remainingSupply);  // Debug log for remainingSupply

        // Update the UI with the remaining supply
        document.getElementById("remaining-supply").innerText = remainingSupply;

    } catch (error) {
        console.error("Error updating remaining supply:", error);
    }
}


        async function loadTransactionLog() {
            const transactionLogContainer = document.getElementById("transactions-log");
            transactionLogContainer.innerHTML = "";

            try {
                const transactionsSnapshot = await getDocs(collection(db, "transactions"));
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    if (transaction.sender === currentUser.id || transaction.receiver === currentUser.id) {
                        transactionLogContainer.innerHTML += `<p>${transaction.timestamp}: Sent ${transaction.amount} coins to ${transaction.receiver}</p>`;
                    }
                });
            } catch (error) {
                console.error("Error loading transactions:", error);
                transactionLogContainer.innerHTML = "<p>Failed to load transactions.</p>";
            }
        }

        // Event listeners
        document.getElementById("login-btn").addEventListener("click", loginUser);
        document.getElementById("send-btn").addEventListener("click", sendCoins);
    </script>
</body>
</html>
